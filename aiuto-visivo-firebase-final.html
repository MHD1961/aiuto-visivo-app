<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aiuto Visivo - Ing. Maher Madany</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .header .developer {
            font-size: 1em;
            color: #4CAF50;
            font-weight: bold;
        }

        .welcome-message {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2em;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .section h2 {
            margin-bottom: 20px;
            color: #4CAF50;
        }

        .btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: scale(1.02);
        }

        .btn-info {
            background: #2196F3;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        textarea {
            font-family: monospace;
            font-size: 12px;
            height: 150px;
            resize: vertical;
        }

        .place-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .place-info {
            flex: 1;
        }

        .place-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .place-type {
            opacity: 0.8;
            font-size: 0.9em;
        }

        .place-actions {
            display: flex;
            gap: 10px;
        }

        .small-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
            display: none;
        }

        .status.show {
            display: block;
        }

        .success { background: rgba(76, 175, 80, 0.3); }
        .error { background: rgba(244, 67, 54, 0.3); }
        .info { background: rgba(33, 150, 243, 0.3); }

        .child-mode {
            display: none;
            text-align: center;
            padding: 50px 20px;
        }

        .child-mode.active {
            display: block;
        }

        .child-mode .big-button {
            width: 90%;
            max-width: 400px;
            height: 150px;
            font-size: 2.5em;
            margin: 20px auto;
            border-radius: 30px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
            color: white;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .child-mode .big-button:active {
            transform: scale(0.95);
        }

        .toggle-mode {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.3);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
        }

        .connection-status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: bold;
        }

        .status-connected {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
        }

        .status-disconnected {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .config-example {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 11px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <!-- Toggle Mode Button -->
    <button class="toggle-mode" onclick="toggleMode()">
        <span id="modeText">Modalit√† Bambino</span>
    </button>

    <!-- Parent Mode -->
    <div class="container" id="parentMode">
        <!-- Header -->
        <div class="header">
            <h1>üëÅÔ∏è Aiuto Visivo</h1>
            <div class="subtitle">Sistema di assistenza per bambini ipovedenti</div>
            <div class="developer">Sviluppato da: Ing. Maher Madany</div>
        </div>

        <!-- Welcome Message -->
        <div class="welcome-message" id="welcomeMessage">
            Benvenuto nel sistema Aiuto Visivo<br>
            Progetto dell'Ing. Maher Madany per aiutare i bambini ipovedenti
        </div>

        <!-- Connection Status -->
        <div class="connection-status status-disconnected" id="connectionStatus">
            üî¥ Firebase non configurato
        </div>

        <!-- Firebase Configuration -->
        <div class="section" id="configSection">
            <h2>‚öôÔ∏è Configurazione Firebase</h2>
            <p>Incolla qui la configurazione Firebase dal tuo progetto:</p>
            
            <textarea id="firebaseConfig" placeholder="Incolla qui il codice firebaseConfig = { ... }"></textarea>
            
            <div class="config-example">
                Esempio:<br>
                const firebaseConfig = {<br>
                &nbsp;&nbsp;apiKey: "...",<br>
                &nbsp;&nbsp;authDomain: "...",<br>
                &nbsp;&nbsp;projectId: "...",<br>
                &nbsp;&nbsp;storageBucket: "...",<br>
                &nbsp;&nbsp;messagingSenderId: "...",<br>
                &nbsp;&nbsp;appId: "..."<br>
                };
            </div>
            
            <button class="btn btn-primary" onclick="saveFirebaseConfig()">
                üíæ Salva Configurazione
            </button>
        </div>

        <!-- Add Place Section (Initially Hidden) -->
        <div class="section" id="addPlaceSection" style="display: none;">
            <h2>‚ûï Aggiungi Nuovo Luogo</h2>
            
            <input type="text" id="placeName" placeholder="Nome del luogo (es: Casa, Scuola)">
            
            <select id="placeType">
                <option value="casa">üè† Casa</option>
                <option value="scuola">üè´ Scuola</option>
                <option value="fermata">üöå Fermata Bus</option>
                <option value="negozio">üõí Negozio</option>
                <option value="parco">üå≥ Parco</option>
                <option value="ospedale">üè• Ospedale</option>
                <option value="amico">üë• Casa Amico</option>
                <option value="altro">üìç Altro</option>
            </select>
            
            <input type="text" id="placeAddress" placeholder="Indirizzo (opzionale)">
            
            <button class="btn btn-primary" onclick="saveCurrentLocation()">
                üìç Usa Posizione Attuale
            </button>
            
            <button class="btn btn-info" onclick="saveManualLocation()">
                ‚úèÔ∏è Inserisci Manualmente
            </button>
        </div>

        <!-- Places List (Initially Hidden) -->
        <div class="section" id="placesSection" style="display: none;">
            <h2>üìã Luoghi Salvati</h2>
            <div id="placesList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Caricamento...</p>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div class="status" id="statusMessage"></div>
    </div>

    <!-- Child Mode -->
    <div class="child-mode" id="childMode">
        <h1 style="font-size: 3em; margin-bottom: 50px;">üë¶ Dove Vuoi Andare?</h1>
        
        <button class="big-button" onclick="navigateToPlace('casa')">
            üè† CASA
        </button>
        
        <button class="big-button" onclick="navigateToPlace('scuola')">
            üè´ SCUOLA
        </button>
        
        <button class="big-button" onclick="navigateToPlace('fermata')">
            üöå FERMATA BUS
        </button>
        
        <button class="big-button" onclick="whereAmI()">
            üìç DOVE SONO?
        </button>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Global Variables
        let db = null;
        let savedPlaces = [];
        let isChildMode = false;
        const synth = window.speechSynthesis;

        // Initialize on Load
        window.addEventListener('load', () => {
            // Welcome message
            speak('Benvenuto in Aiuto Visivo, progetto dell\'Ingegnere Maher Madany', false);
            
            // Check for saved configuration
            const savedConfig = localStorage.getItem('firebaseConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    initializeFirebase(config);
                } catch (e) {
                    console.error('Error loading saved config:', e);
                }
            }
        });

        // Save Firebase Configuration
        function saveFirebaseConfig() {
            const configText = document.getElementById('firebaseConfig').value;
            
            if (!configText) {
                showStatus('Per favore, incolla la configurazione Firebase', 'error');
                return;
            }

            try {
                // Extract config object from text
                const configMatch = configText.match(/const firebaseConfig = ({[\s\S]*?});/);
                if (configMatch) {
                    const config = eval('(' + configMatch[1] + ')');
                    
                    // Save to localStorage
                    localStorage.setItem('firebaseConfig', JSON.stringify(config));
                    
                    // Initialize Firebase
                    initializeFirebase(config);
                } else {
                    showStatus('Formato configurazione non valido', 'error');
                }
            } catch (e) {
                console.error('Error parsing config:', e);
                showStatus('Errore nella configurazione', 'error');
            }
        }

        // Initialize Firebase
        function initializeFirebase(config) {
            try {
                // Initialize Firebase
                firebase.initializeApp(config);
                
                // Initialize Firestore
                db = firebase.firestore();
                
                // Update UI
                document.getElementById('connectionStatus').className = 'connection-status status-connected';
                document.getElementById('connectionStatus').innerHTML = 'üü¢ Firebase Connesso';
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('addPlaceSection').style.display = 'block';
                document.getElementById('placesSection').style.display = 'block';
                
                // Load places
                loadPlaces();
                
                // Listen for real-time updates
                listenForUpdates();
                
                showStatus('‚úÖ Firebase connesso con successo!', 'success');
                speak('Firebase connesso. Sistema pronto. Progetto dell\'Ingegnere Maher Madany', true);
                
            } catch (error) {
                console.error('Firebase init error:', error);
                showStatus('Errore connessione Firebase', 'error');
            }
        }

        // Load Places from Firebase
        function loadPlaces() {
            if (!db) return;
            
            db.collection('places').get().then((querySnapshot) => {
                savedPlaces = [];
                querySnapshot.forEach((doc) => {
                    savedPlaces.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                if (savedPlaces.length === 0) {
                    // Add default places
                    addDefaultPlaces();
                } else {
                    displayPlaces();
                }
            }).catch((error) => {
                console.error("Error loading places:", error);
                showStatus('Errore caricamento luoghi', 'error');
            });
        }

        // Listen for Real-time Updates
        function listenForUpdates() {
            if (!db) return;
            
            db.collection('places').onSnapshot((snapshot) => {
                savedPlaces = [];
                snapshot.forEach((doc) => {
                    savedPlaces.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                displayPlaces();
            });
        }

        // Add Default Places
        function addDefaultPlaces() {
            const defaultPlaces = [
                {
                    name: "Casa",
                    type: "casa",
                    address: "Via Nazario Sauro 38, Torbole Casaglia",
                    latitude: 45.511938,
                    longitude: 10.121371,
                    timestamp: new Date()
                },
                {
                    name: "Scuola Primaria",
                    type: "scuola",
                    address: "Via Donatori di Sangue, 13, Torbole Casaglia",
                    latitude: 45.511938,
                    longitude: 10.121371,
                    timestamp: new Date()
                },
                {
                    name: "Fermata Bus 203",
                    type: "fermata",
                    address: "Via G.Mazzini, Portone",
                    latitude: 45.511938,
                    longitude: 10.121371,
                    timestamp: new Date()
                }
            ];

            defaultPlaces.forEach(place => {
                db.collection('places').add(place);
            });
            
            showStatus('Luoghi predefiniti aggiunti', 'success');
        }

        // Save Current Location
        function saveCurrentLocation() {
            const name = document.getElementById('placeName').value;
            const type = document.getElementById('placeType').value;
            const address = document.getElementById('placeAddress').value;
            
            if (!name) {
                showStatus('Inserisci un nome per il luogo', 'error');
                speak('Inserisci un nome per il luogo', true);
                return;
            }

            if (!db) {
                showStatus('Firebase non configurato', 'error');
                return;
            }
            
            showStatus('Ottengo la posizione...', 'info');
            speak('Sto salvando la posizione attuale', true);
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const place = {
                        name: name,
                        type: type,
                        address: address,
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date()
                    };
                    
                    db.collection('places').add(place).then(() => {
                        document.getElementById('placeName').value = '';
                        document.getElementById('placeAddress').value = '';
                        
                        showStatus(`‚úÖ "${name}" salvato!`, 'success');
                        speak(`Ho salvato ${name}`, true);
                    }).catch((error) => {
                        console.error("Error:", error);
                        showStatus('Errore nel salvare', 'error');
                    });
                },
                (error) => {
                    showStatus('‚ùå Errore GPS', 'error');
                    speak('Non riesco a ottenere la posizione', true);
                }
            );
        }

        // Save Manual Location
        function saveManualLocation() {
            const name = document.getElementById('placeName').value;
            const type = document.getElementById('placeType').value;
            const address = document.getElementById('placeAddress').value;
            
            if (!name || !address) {
                showStatus('Inserisci nome e indirizzo', 'error');
                return;
            }

            if (!db) {
                showStatus('Firebase non configurato', 'error');
                return;
            }
            
            const place = {
                name: name,
                type: type,
                address: address,
                latitude: null,
                longitude: null,
                timestamp: new Date()
            };
            
            db.collection('places').add(place).then(() => {
                document.getElementById('placeName').value = '';
                document.getElementById('placeAddress').value = '';
                
                showStatus(`‚úÖ "${name}" salvato!`, 'success');
                speak(`Ho salvato ${name}`, true);
            });
        }

        // Display Places
        function displayPlaces() {
            const list = document.getElementById('placesList');
            
            if (savedPlaces.length === 0) {
                list.innerHTML = '<p style="text-align: center; opacity: 0.7;">Nessun luogo salvato</p>';
                return;
            }
            
            list.innerHTML = '';
            savedPlaces.forEach((place) => {
                const placeDiv = document.createElement('div');
                placeDiv.className = 'place-item';
                
                const icon = getPlaceIcon(place.type);
                
                placeDiv.innerHTML = `
                    <div class="place-info">
                        <div class="place-name">${icon} ${place.name}</div>
                        <div class="place-type">${place.address || 'Coordinate salvate'}</div>
                    </div>
                    <div class="place-actions">
                        <button class="small-btn btn-info" onclick="navigateToPlace('${place.id}')">
                            üß≠ Vai
                        </button>
                        <button class="small-btn btn-danger" onclick="deletePlace('${place.id}')">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
                
                list.appendChild(placeDiv);
            });
        }

        // Delete Place
        function deletePlace(placeId) {
            if (!db) return;
            
            const place = savedPlaces.find(p => p.id === placeId);
            if (confirm(`Eliminare "${place.name}"?`)) {
                db.collection('places').doc(placeId).delete().then(() => {
                    showStatus(`"${place.name}" eliminato`, 'info');
                    speak(`Ho eliminato ${place.name}`, true);
                });
            }
        }

        // Navigate to Place
        function navigateToPlace(placeIdOrType) {
            let place;
            
            if (placeIdOrType.length > 10) {
                // It's an ID
                place = savedPlaces.find(p => p.id === placeIdOrType);
            } else {
                // It's a type
                place = savedPlaces.find(p => p.type === placeIdOrType);
            }
            
            if (!place) {
                speak('Questo luogo non √® stato salvato', true);
                return;
            }
            
            speak(`Ti porto a ${place.name}`, true);
            
            if (place.latitude && place.longitude) {
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${place.latitude},${place.longitude}`, '_blank');
            }
        }

        // Where Am I?
        function whereAmI() {
            speak('Sto cercando dove ti trovi', true);
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}&accept-language=it`)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.address) {
                                const street = data.address.road || '';
                                const city = data.address.city || data.address.town || '';
                                
                                let message = 'Ti trovi ';
                                if (street) message += `in ${street}`;
                                if (city) message += `, ${city}`;
                                
                                speak(message, true);
                            }
                        });
                },
                (error) => {
                    speak('Non riesco a trovare dove sei', true);
                }
            );
        }

        // Toggle Mode
        function toggleMode() {
            isChildMode = !isChildMode;
            
            const parentMode = document.getElementById('parentMode');
            const childMode = document.getElementById('childMode');
            const modeText = document.getElementById('modeText');
            
            if (isChildMode) {
                parentMode.style.display = 'none';
                childMode.classList.add('active');
                modeText.textContent = 'Modalit√† Genitore';
                speak('Modalit√† bambino attivata', true);
            } else {
                parentMode.style.display = 'block';
                childMode.classList.remove('active');
                modeText.textContent = 'Modalit√† Bambino';
                speak('Modalit√† genitore attivata', true);
            }
        }

        // Helper Functions
        function getPlaceIcon(type) {
            const icons = {
                casa: 'üè†',
                scuola: 'üè´',
                fermata: 'üöå',
                negozio: 'üõí',
                parco: 'üå≥',
                ospedale: 'üè•',
                amico: 'üë•',
                altro: 'üìç'
            };
            return icons[type] || 'üìç';
        }

        function showStatus(message, type) {
            const status = document.getElementById('statusMessage');
            status.textContent = message;
            status.className = `status show ${type}`;
            
            setTimeout(() => {
                status.classList.remove('show');
            }, 5000);
        }

        function speak(text, priority = false) {
            if (priority) {
                synth.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'it-IT';
            utterance.rate = 0.9;
            
            synth.speak(utterance);
        }
    </script>
</body>
</html>
